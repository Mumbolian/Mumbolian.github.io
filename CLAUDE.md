# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

T-Man's Snooze Schedule is a pure client-side nap scheduling app for parents. The entire application is contained in a single `index.html` file with embedded CSS and JavaScript‚Äîno build system, no dependencies, no backend.

Live URL: https://bingpotstudio.com

## Architecture

### Single-File Structure

The entire app lives in `index.html`:
- **Lines 1-968**: HTML structure and embedded CSS styles
- **Lines 969-2900+**: JavaScript application logic (wrapped in IIFE)
- No external dependencies, frameworks, or build tools

### Key Architectural Patterns

1. **LocalStorage-based persistence**: All settings stored in `localStorage` under key `napPlannerSettings_v6`
   - Schema includes mode-specific configurations (`twoNapLengths`, `threeNapLengths`)
   - Backwards compatible with v5 settings
   - Settings auto-save on every change via `recomputeSchedule()` -> `saveSettings()`

2. **Reactive UI updates**: The `recomputeSchedule()` function (line ~2300) is the central coordinator
   - Called on every input change
   - Guards against recursion with `isRecomputing` flag
   - Validates inputs, builds schedule, updates DOM
   - All UI changes flow through this function

3. **Dual-mode configuration**: Maintains separate settings for 2-nap vs 3-nap schedules
   - User can configure both modes independently via modal
   - App auto-switches modes when constraints require it
   - Mode-specific settings preserved and reused when switching

## Core Algorithms

### Schedule Building: `tryBuildSchedule()` (line ~1833)

The fundamental scheduler that works backwards from bedtime:

1. Calculate total available awake time: `totalDay - totalNapTime - lastWake`
2. Distribute remaining time across wake windows (one before each nap)
3. Wake windows grow from `minWake` ‚Üí `maxWake`, preferring increasing pattern
4. Last wake window (`lastWake`) is fixed
5. Returns schedule object with `{ok, items, wakeWindowDurations, ...}`

**Critical constraints (never violated)**:
- Wake window parameters (`minWake`, `maxWake`, `lastWake`) are biological constraints
- These are NEVER adjusted by any algorithm
- All adjustments work within these hard limits

### Constraint Satisfaction: `adjustScheduleForConstraints()` (line ~2040)

Unified linear programming approach that simultaneously adjusts multiple variables:

**Two strategies**:

1. **Unified adjustment** - Tries combinations of:
   - Bedtime adjustments: 0, -15, -30, -45, +15, +30 minutes (in that order)
   - Nap length adjustments: ¬±5 to ¬±30 minutes (5-min increments)
   - Pairwise nap transfers: Move time between naps (e.g., Nap 1 -10, Nap 2 +10)
   - Generated by `generateNapCombinations()` (line ~1953)
   - For each bedtime adjustment, tests ~150 nap combinations
   - Returns first feasible solution found

2. **Switch nap count** - If unified adjustment fails:
   - Tries alternative mode (2 ‚Üî 3 naps)
   - Uses stored settings for that mode (or defaults)
   - Drastically changes schedule layout

**Validation**: `validateConstraints()` (line ~2176) checks:
- "Must be awake by T": No nap overlaps with time T
- "Must be asleep during S-E": At least one nap fully covers window

See `UNIFIED_LP_IMPLEMENTATION.md` and `LINEAR_APPROACH.md` for detailed algorithm documentation.

### Auto-Adjustment: `tryAutoAdjustNapsToFit()` (line ~2000)

Separate from constraint satisfaction‚Äîruns automatically even without constraints:
- Tries minor nap adjustments (¬±5 to ¬±15 min) to fit schedule
- Never reduces naps below 30-minute minimum
- Minimal approach before constraint satisfaction kicks in

### Power Sleep Mode: `applyPowerSleep()` (line ~2271)

Proportionally boosts nap times to reach target total sleep duration:
- Default target: 180 minutes (3 hours)
- Distributes missing time proportionally across naps
- Example: [30, 60, 30] (120 min total) ‚Üí [45, 90, 45] (180 min target)

### Actual Naps Tracking

- Users can record actual nap times via "Track Actual Naps" modal
- Stored in separate localStorage key per date
- When actual times exist: `tryBuildScheduleWithActuals()` (line ~1687) modifies schedule algorithm
- Midnight reset: `checkMidnightReset()` (line ~1283) clears stale actual naps

## Development Commands

This is a static site with no build process. To develop:

```bash
# Serve locally (any HTTP server works)
python3 -m http.server 8000
# or
npx serve

# View in browser
open http://localhost:8000
```

### Deployment

Hosted on GitHub Pages. To deploy:

```bash
git add index.html
git commit -m "Description of changes"
git push origin main
```

Changes go live automatically at https://bingpotstudio.com (custom domain via CNAME).

## Version Management

**IMPORTANT: Always increment the version number when making any code changes.**

- App version is set in the `APP_VERSION` constant (line ~985): `const APP_VERSION = "1.x.y";`
- Version is displayed in the footer via `versionDisplay` element
- **Version must be incremented BEFORE committing any changes**
- Versioning follows semantic versioning (MAJOR.MINOR.PATCH):
  - **MAJOR**: Breaking changes or major redesigns
  - **MINOR**: New features or functionality (e.g., adding maxFirstWake parameter)
  - **PATCH**: Bug fixes, minor tweaks, documentation updates
- Format displayed to users: `v1.x` (e.g., "v1.9.0" shows as "v1.9")

## Testing Approach

No automated tests. Manual testing workflow:

1. Test with default settings (3 naps: 30/60/30, wake: 07:00, bed: 20:30)
2. Test mode switching (2 ‚Üî 3 naps)
3. Test constraints:
   - "Must be awake by" (e.g., 13:00)
   - "Must be asleep during" (e.g., 15:00-15:30)
4. Test edge cases:
   - Midnight-crossing bedtimes
   - Extreme wake window settings
   - Infeasible constraints
5. Test Power Sleep Mode with various targets

See `test_constraint_analysis.md` for constraint-specific test cases.

## Important Implementation Details

### Modal Management

Three modals managed via open/close functions:
- **Constraints modal**: `openModal()` / `closeModal()`
- **Track Naps modal**: `openActualNapsModal()` / `closeActualNapsModal()`
- **Nap Config modal**: `openNapConfigModal()` / `closeNapConfigModal()` (line ~1144)

Nap Config modal allows editing both 2-nap and 3-nap settings simultaneously.

### Visual Feedback System

- **Amber haze**: Schedule cards get amber border + "‚ö†Ô∏è Adjusted +X min" when nap lengths modified
- **Configure button highlight**: Gets amber glow when adjustments active
- **Constraint indicators**: Button shows count: "üéØ Constraints (2)"
- **Success/warning messages**: Color-coded in `warningBox` div (green = success, red = failure)
- **Wake window display**: Each schedule item shows "‚Üë Xh Ymin awake" duration
- **Preference mismatch**: Toggle switch indicates when actual mode differs from preference

### Time Handling

- `toMinutes(timeStr)`: Converts "HH:MM" ‚Üí minutes since midnight (line ~1249)
- `fromMinutes(totalMinutes)`: Converts minutes ‚Üí "HH:MM" with next-day handling (line ~1256)
- Bedtime can exceed 24 hours (e.g., 1440+ = next day)

### Settings Schema Evolution

Current: v6 (mode-specific nap configurations)
- Stores `twoNapLengths: {nap1, nap2}` and `threeNapLengths: {nap1, nap2, nap3}` separately
- Previous: v5 (single nap configuration)
- Migration: `initFromStorageOrDefaults()` handles backwards compatibility (line ~1607)

## Common Modification Scenarios

### Adding a new input field
1. Add HTML input in appropriate card section
2. Add variable to `loadSettings()` / `saveSettings()` (lines ~1272, ~1295)
3. Read value in `recomputeSchedule()` (line ~2300)
4. Use in schedule calculation

### Modifying constraint satisfaction
1. Edit `adjustScheduleForConstraints()` (line ~2040)
2. Update `generateNapCombinations()` for different search space (line ~1953)
3. Modify `validateConstraints()` for new constraint types (line ~2176)
4. See `UNIFIED_LP_IMPLEMENTATION.md` for algorithm details

### Changing schedule calculation
1. Modify `tryBuildSchedule()` for base algorithm (line ~1833)
2. Update wake window distribution logic (lines ~1879-1888)
3. Ensure biological constraints (minWake, maxWake, lastWake) remain respected

## Documentation Files

- `README.md`: User-facing feature documentation
- `LINEAR_APPROACH.md`: Mathematical formulation of constraint problem
- `UNIFIED_LP_IMPLEMENTATION.md`: Details of unified adjustment algorithm
- `IMPLEMENTATION_NOTES.md`: Historical notes on constraint satisfaction implementation
- `BUGFIX_WAKE_WINDOW_LIMITS.md`: Notes on wake window constraint bug fix
- `test_constraint_analysis.md`: Constraint testing scenarios

## Key Principles

1. **No backend**: Everything runs client-side, no server calls
2. **No frameworks**: Vanilla JavaScript, no React/Vue/etc.
3. **No build step**: Edit `index.html` and refresh browser
4. **Biological constraints are sacred**: Never adjust minWake, maxWake, or lastWake
5. **User settings are preserved**: Nap configurations never modified by adjustments, only displayed schedule changes
6. **Mobile-first**: Primary use case is parents on phones during chaos
